<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Chat Panel | Tournament Sa Kamao</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* ===== UI UNCHANGED ===== */
:root{
  --bg:#020617;
  --card:#0f172a;
  --blue:#38bdf8;
  --purple:#a855f7;
  --green:#22c55e;
  --red:#ef4444;
  --text:#e5e7eb;
  --muted:#94a3b8;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Segoe UI,system-ui,sans-serif;
  background:radial-gradient(circle at top,#1e1b4b,#020617 70%);
  color:var(--text);
}
.header{
  display:flex;
  align-items:center;
  gap:12px;
  padding:14px;
  background:rgba(2,6,23,.95);
  backdrop-filter:blur(10px);
}
.back{
  width:40px;height:40px;border-radius:12px;
  background:linear-gradient(135deg,#60a5fa,#38bdf8);
  display:flex;align-items:center;justify-content:center;
  font-weight:900;cursor:pointer;
}
.title{font-size:17px;font-weight:900;flex:1}
.toggle{
  font-size:12px;
  padding:6px 10px;
  border-radius:10px;
  background:#020617;
  border:1px solid #334155;
}
.main{display:flex;height:calc(100vh - 70px)}
.users{
  width:40%;
  background:#020617;
  border-right:1px solid #1e293b;
  overflow-y:auto;
}
.user{
  padding:14px;
  border-bottom:1px solid #1e293b;
  cursor:pointer;
}
.user:hover{background:#0f172a}
.user small{color:var(--muted)}
.chat{flex:1;display:flex;flex-direction:column}
.chat-area{flex:1;padding:14px;overflow-y:auto}
.msg{
  max-width:75%;
  padding:12px;
  border-radius:14px;
  margin-bottom:10px;
  font-size:14px;
}
.admin{
  background:linear-gradient(135deg,var(--blue),var(--purple));
  margin-left:auto;
}
.user-msg{
  background:#020617;
  border:1px solid #334155;
}
.input-bar{
  padding:10px;
  display:flex;
  gap:8px;
  background:#020617;
}
input{
  flex:1;
  padding:12px;
  border-radius:14px;
  border:none;
  background:#0f172a;
  color:#fff;
}
button{
  padding:12px 16px;
  border-radius:14px;
  border:none;
  font-weight:900;
  cursor:pointer;
}
.send{background:var(--green)}
.block{background:var(--red);color:#fff}
</style>
</head>

<body>

<script>
/* ===== ADMIN CHECK ===== */
if(localStorage.getItem("isAdmin")!=="true"){
  location.href="index.html";
}

/* ===== API CONFIG ===== */
const API_URL="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec";
function api(d){
  return fetch(API_URL,{method:"POST",body:JSON.stringify(d)})
         .then(r=>r.json());
}
</script>

<div class="header">
  <div class="back" onclick="location.href='profile.html'">‚Üê</div>
  <div class="title">Admin Chat Panel</div>
  <div class="toggle" id="globalToggle">Chat: ON</div>
</div>

<div class="main">

  <!-- USER LIST -->
  <div class="users" id="userList"></div>

  <!-- CHAT -->
  <div class="chat">
    <div class="chat-area" id="chatArea"></div>

    <div class="input-bar">
      <input id="adminMsg" placeholder="Type reply">
      <button class="send" onclick="sendAdmin()">SEND</button>
      <button class="block" onclick="toggleBlock()">BLOCK</button>
    </div>
  </div>

</div>

<!-- SOUND -->
<audio id="tap" src="assets/tap.mp3"></audio>
<audio id="bgm" src="assets/bgm.mp3" loop></audio>

<script>
/* ===== MUSIC ===== */
const bgm=document.getElementById("bgm");
bgm.volume=0.35;
bgm.play().catch(()=>{});

/* ===== TAP SOUND ===== */
document.addEventListener("touchstart",()=>{
  tap.currentTime=0;
  tap.play().catch(()=>{});
});

let currentUser=null;
let isBlocked=false;

/* ===== LOAD USERS ===== */
async function loadUsers(){
  const d=await api({action:"ADMIN_USERS"});
  userList.innerHTML="";
  d.users.forEach(u=>{
    const div=document.createElement("div");
    div.className="user";
    div.innerHTML=`${u.name}<br><small>${u.blocked?"Blocked":"Active"}</small>`;
    div.onclick=()=>openChat(u.name,u.blocked);
    userList.appendChild(div);
  });
}
loadUsers();

/* ===== OPEN CHAT ===== */
async function openChat(name,blocked){
  currentUser=name;
  isBlocked=blocked;
  chatArea.innerHTML="";
  const d=await api({action:"ADMIN_GET_CHAT",user:name});
  d.messages.forEach(m=>{
    const div=document.createElement("div");
    div.className="msg "+(m.by==="admin"?"admin":"user-msg");
    div.innerText=m.text;
    chatArea.appendChild(div);
  });
  chatArea.scrollTop=chatArea.scrollHeight;
}

/* ===== SEND ===== */
async function sendAdmin(){
  if(!currentUser) return;
  const txt=adminMsg.value.trim();
  if(!txt) return;

  const div=document.createElement("div");
  div.className="msg admin";
  div.innerText=txt;
  chatArea.appendChild(div);
  chatArea.scrollTop=chatArea.scrollHeight;
  adminMsg.value="";

  await api({action:"ADMIN_SEND",user:currentUser,message:txt});
}

/* ===== BLOCK / UNBLOCK ===== */
async function toggleBlock(){
  if(!currentUser) return;
  isBlocked=!isBlocked;
  await api({
    action:"ADMIN_BLOCK",
    user:currentUser,
    blocked:isBlocked
  });
  alert(isBlocked?"User chat blocked":"User chat unblocked");
  loadUsers();
}

/* ===== GLOBAL CHAT ON/OFF ===== */
let chatOn=true;
globalToggle.onclick=async()=>{
  chatOn=!chatOn;
  globalToggle.innerText="Chat: "+(chatOn?"ON":"OFF");
  await api({action:"CHAT_GLOBAL_STATUS",enabled:chatOn});
};
</script>

</body>
</html>
